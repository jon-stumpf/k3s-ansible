---

################################################################################
# Create {{ k3s.config.cluster }} on ansible controller
#
- name: Create kubeconfig on ansible controller, {{ k3s.config.cluster }}
  when: not ansible_check_mode
  run_once: true
  block:
    # Use a temporary file so that the node is marked 'changed' only when the
    # kubeconfig file is new or different.  See task "Copy kubeconfig file" below.

    - name: Create temporary file for kube config
      ansible.builtin.tempfile:
        state: file
      register: tempfile
      changed_when: false

    - name: Copy system kubeconfig, {{ str }}
      vars:
        src: "{{ k3s.dir.etc }}/{{ k3s.config.system }}"
        dest: "{{ tempfile.path }}"
        str: "{{ src }} --> {{ dest }}"
      ansible.builtin.copy:
        remote_src: true
        src: "{{ src }}"
        dest: "{{ dest }}"
        mode: "u=rw,g=,o="
      changed_when: false

    - name: Replace localhost cluster endpoint with {{ str }}
      vars:
        str: "{{ k3s.cluster.address }}:{{ k3s.cluster.port }}"
      ansible.builtin.command: >-
        {{ k3s.dir.bin }}/kubectl config set-cluster default
          --server=https://{{ k3s.cluster.address }}:{{ k3s.cluster.port }}
          --kubeconfig {{ tempfile.path }}
      changed_when: false

    - name: Fetch updated tempfile, {{ str }}
      vars:
        src: "{{ tempfile.path }}"
        dest: "{{ k3s.config.cluster }}"  # placed in playbook/
        str: "{{ src }} --> {{ dest }}"
      ansible.builtin.fetch:
        src: "{{ src }}"
        dest: "{{ dest }}"
        flat: true

    - name: Remove tempfile, {{ tempfile.path }}
      ansible.builtin.file:
        path: "{{ tempfile.path }}"
        state: absent
      changed_when: false

#########################################
# Create kubeconfig files on every server
#

- name: Create kubeconfig files on every server
  when: not ansible_check_mode
  block:
    - name: Create local kubeconfig directory, {{ path }}
      vars:
        path: "~{{ ansible_user }}/{{ k3s.config.userdir }}"
      ansible.builtin.file:
        path: "{{ path }}"
        state: directory
        owner: "{{ ansible_user }}"
        mode: "u=rwx,g=rx,o="

    - name: Copy cluster config, {{ str }}
      vars:
        src: "{{ k3s.config.cluster }}"
        dest: "~{{ ansible_user }}/{{ k3s.config.userdir }}/{{ k3s.config.cluster }}"
        str: "{{ src }} --> {{ dest }}"
      ansible.builtin.copy:
        src: "{{ src }}"
        dest: "{{ dest }}"
        owner: "{{ ansible_user }}"
        mode: "u=rw,g=,o="

    - name: Copy localhost config, {{ str }}
      vars:
        src: "{{ k3s.dir.etc }}/{{ k3s.config.system }}"
        dest: "~{{ ansible_user }}/{{ k3s.config.userdir }}/{{ k3s.config.local }}"
        str: "{{ src }} --> {{ dest }}"
      ansible.builtin.copy:
        remote_src: true
        src: "{{ src }}"
        dest: "{{ dest }}"
        owner: "{{ ansible_user }}"
        mode: "u=rw,g=,o="
